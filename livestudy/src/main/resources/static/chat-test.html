<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Test Page</title>
    <script src="/js/jquery-3.5.1.slim.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h2>회원가입</h2>
    <label for="signup-email"></label><input id="signup-email" placeholder="이메일" />
    <label for="signup-password"></label><input id="signup-password" placeholder="비밀번호" type="password" />
    <label for="signup-nickname"></label><input id="signup-nickname" placeholder="닉네임" />
    <label for="signup-intro"></label><input id="signup-intro" placeholder="자기소개" />
    <button onclick="signup()">회원가입</button>

    <h2>로그인</h2>
    <label for="login-email"></label><input id="login-email" placeholder="이메일" />
    <label for="login-password"></label><input id="login-password" placeholder="비밀번호" type="password" />
    <button onclick="login()">로그인</button>

    <h2>WebSocket Chat Test</h2>
    <label for="msg"></label>
    <input id="msg" placeholder="메시지를 입력해주세요!" />
    <button onclick="sendMessage()">전송</button>
    <ul id="messages"></ul>

    <script>
        function connectWebSocket(token) {
            const socket = new SockJS("/ws");
            stompClient = Stomp.over(socket);

            stompClient.connect(
                { Authorization: "Bearer " + token },
                function (frame) {
                    console.log("✅ STOMP 연결 성공:", frame);

                    // ✔ 구독할 topic 변경
                    stompClient.subscribe("/topic/chat.room.test-room", function (msg) {
                        const chat = JSON.parse(msg.body);
                        const li = document.createElement("li");
                        li.innerText = `📨 ${chat.sender}: ${chat.content}`;
                        document.getElementById("messages").appendChild(li);
                    });
                },
                function (error) {
                    console.error("❌ STOMP 연결 실패:", error);
                }
            );
        }

        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                alert("WebSocket에 연결되어 있지 않습니다.");
                return;
            }

            const msg = document.getElementById("msg").value;

            const chatMessage = {
                roomId: "test-room",   // 방 ID (고정값이든 동적이든 가능)
                content: msg
            };

            stompClient.send("/pub/chat.send", {}, JSON.stringify(chatMessage));
            document.getElementById("msg").value = "";
        }

    </script>
</body>
</html>