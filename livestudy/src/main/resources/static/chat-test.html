<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Test Page</title>
    <script src="/js/jquery-3.5.1.slim.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <h2>íšŒì›ê°€ì…</h2>
    <label for="signup-email"></label><input id="signup-email" placeholder="ì´ë©”ì¼" />
    <label for="signup-password"></label><input id="signup-password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" />
    <label for="signup-nickname"></label><input id="signup-nickname" placeholder="ë‹‰ë„¤ì„" />
    <label for="signup-intro"></label><input id="signup-intro" placeholder="ìê¸°ì†Œê°œ" />
    <button onclick="signup()">íšŒì›ê°€ì…</button>

    <h2>ë¡œê·¸ì¸</h2>
    <label for="login-email"></label><input id="login-email" placeholder="ì´ë©”ì¼" />
    <label for="login-password"></label><input id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password" />
    <button onclick="login()">ë¡œê·¸ì¸</button>

    <h2>WebSocket Chat Test</h2>
    <label for="msg"></label>
    <input id="msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!" />
    <button onclick="sendMessage()">ì „ì†¡</button>
    <ul id="messages"></ul>

    <script>
        let stompClient = null;
        let jwtToken = null;

        async function signup() {
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;
            const nickname = document.getElementById("signup-nickname").value;
            const introduction = document.getElementById("signup-intro").value;

            try {
                const res = await fetch("/api/auth/signup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        email,
                        password,
                        nickname,
                        introduction,
                        profileImage: null,
                        socialProvider: null
                    }),
                });

                if (res.status === 201) {
                    alert("âœ… íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•˜ì„¸ìš”.");
                } else {
                    const error = await res.text();
                    alert("âŒ íšŒì›ê°€ì… ì‹¤íŒ¨: " + error);
                }
            } catch (err) {
                alert("âŒ íšŒì›ê°€ì… ì—ëŸ¬: " + err.message);
            }
        }

        async function login() {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            try {
                const res = await fetch("/api/auth/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password }),
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(errText);
                }

                const data = await res.json();
                jwtToken = data.token;
                alert("âœ… ë¡œê·¸ì¸ ì„±ê³µ! WebSocket ì—°ê²° ì‹œë„í•©ë‹ˆë‹¤.");

                connectWebSocket(jwtToken);
            } catch (err) {
                alert("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + err.message);
            }
        }

        function connectWebSocket(token) {
            const socket = new SockJS("https://api.live-study.com/ws");
            stompClient = Stomp.over(socket);

            stompClient.connect(
                { Authorization: "Bearer " + token },
                function (frame) {
                    console.log("STOMP ì—°ê²° ì„±ê³µ:", frame);
                    stompClient.subscribe("/topic/messages", function (msg) {
                        const li = document.createElement("li");
                        li.innerText = "ğŸ“¨ " + msg.body;
                        document.getElementById("messages").appendChild(li);
                    });
                },
                function (error) {
                    console.error("STOMP ì—°ê²° ì‹¤íŒ¨:", error);
                }
            );
        }

        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                alert("WebSocketì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            const msg = document.getElementById("msg").value;
            stompClient.send("/pub/chat", {}, msg);
            document.getElementById("msg").value = "";
        }
    </script>
</body>
</html>